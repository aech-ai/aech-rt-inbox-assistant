# CLI Development Guide

Build command-line capabilities that integrate with Agent Aech.

## Quick Start

1. **Create a Python CLI** using Typer
2. **Generate manifest**: `python generate_manifest.py aech_cli_yourname`
3. **Package as wheel**: `python -m build --wheel`
4. **Copy to**: `capabilities/clis/` (sandbox) or `capabilities/core/clis/` (agent-only)
5. **Rebuild**: `docker compose build`

Your CLI is now available to the agent.

## CLI Types

- **Public CLIs** (`capabilities/clis/`): Safe for sandboxed workers (documents, translator, pbwc)
- **Core CLIs** (`capabilities/core/clis/`): Agent-only, privileged access (msgraph)

## How It Works

1. During Docker build, `installer.py` discovers `.whl` files
2. Reads `manifest.json` directly from each wheel
3. Generates `capabilities/manifest.json` with all CLIs
4. Agent loads manifest at runtime

**The `manifest.json` inside your wheel is the source of truth.**

## Manifest Format

Any intelligible JSON format works, but using `generate_manifest.py` ensures accuracy and compactness:

```json
{
  "name": "yourname",
  "command": "aech-cli-yourname",
  "desc": "What this CLI does (1-2 sentences)",
  "actions": {
    "action-name": {
      "desc": "What this action does",
      "args": ["required_arg", "[optional_arg]"],
      "opts": ["--option: [default] description"],
      "out": "<output-dir>/output_file.xlsx"
    }
  }
}
```

### Key Fields

- `name`: Short name (e.g., "pbwc", "msgraph")
- `command`: Full CLI command (e.g., "aech-cli-pbwc")
- `desc`: CLI description
- `actions`: Map of action names to action definitions

### Action Fields

- `desc`: Action description
- `args`: Positional arguments - use `[brackets]` for optional
- `opts`: Options in format `--name: [default] description`
- `out`: Output file path pattern (only if action writes files)

## Project Setup

### Use the Template

```bash
cp -r development/cli_template ~/my-cli-project
cd ~/my-cli-project
mv aech_cli_TEMPLATE aech_cli_myname
sed -i '' 's/TEMPLATE/myname/g' **/*
```

See [development/cli_template/README.md](../development/cli_template/README.md) for complete usage guide.

### Directory Structure

```text
my-cli-project/
├── aech_cli_myname/          # Python package
│   ├── __init__.py
│   ├── main.py              # CLI implementation
│   └── manifest.json        # Generated by generate_manifest.py
├── generate_manifest.py     # AI-assisted generator (copy from template)
├── pyproject.toml
├── .gitignore
└── README.md
```

### pyproject.toml

```toml
[build-system]
requires = ["setuptools>=61.0"]
build-backend = "setuptools.build_meta"

[project]
name = "aech-cli-yourname"
version = "0.1.0"
description = "Your CLI description"
requires-python = ">=3.10"
dependencies = [
    "typer>=0.9.0",
    # Add your dependencies
]

[project.scripts]
aech-cli-yourname = "aech_cli_yourname.main:run"
```

## Implementing Your CLI

### 1. Set Description via Typer

```python
import typer

app = typer.Typer(
    help="What your CLI does (1-2 sentences)",
    no_args_is_help=True,
    add_completion=False
)
```

The `help=` parameter becomes the `desc` field in the manifest.

### 2. Add Commands

```python
@app.command(name="my-action")
def my_action(
    input_path: str = typer.Argument(..., help="Input file"),
    output_dir: str = typer.Option(..., "--output-dir", help="Output directory"),
    limit: int = typer.Option(10, "--limit", help="Max results")
):
    """Process input and write output."""
    # Your implementation
```

### 3. Entry Point

```python
def run() -> None:
    """CLI entry point."""
    app()

if __name__ == "__main__":
    run()
```

### 4. Generate Manifest

```bash
python generate_manifest.py aech_cli_myname
```

This introspects your Typer app and uses an LLM to infer output paths.

## Parameter Types

- **Arguments**: Positional (e.g., `cli action FILE`)
- **Options**: Flags (e.g., `cli action --output-dir DIR`)

In manifest format:

- `args`: `["required", "[optional]"]`
- `opts`: `["--name: [default] description"]`

## Output Paths

Use placeholders in `out` field:

- `<output-dir>`: Output directory parameter
- `<param>`: Any parameter value
- `YYYYMMDD`: Date pattern

Example: `"out": "<output-dir>/report_<date:YYYYMMDD>.xlsx"`

## Embedding Secrets

CLIs must be self-contained with credentials embedded at build time.

### Build Script

```bash
#!/bin/bash
# build_wheel.sh

cat > aech_cli_yourname/_build_config.py <<EOF
# Auto-generated - DO NOT COMMIT
DB_HOST = "postgres.example.com"
DB_PASSWORD = "secret123"
EOF

python -m build --wheel
rm aech_cli_yourname/_build_config.py
```

### Import Config

```python
try:
    from aech_cli_yourname._build_config import DB_HOST, DB_PASSWORD
except ImportError:
    import os
    DB_HOST = os.getenv("DB_HOST", "localhost")
    DB_PASSWORD = os.getenv("DB_PASSWORD")
```

## File I/O Guidelines

- Accept **file paths** as inputs (not stdin)
- Write outputs to **specified directories**
- Return **JSON to stdout** with output file paths
- All paths relative to `/session/` in sandbox

## Testing

```bash
# Test CLI commands work
aech-cli-yourname action-name input.txt --output-dir ./test

# Verify manifest is valid JSON
cat aech_cli_yourname/manifest.json | jq .
```

## Integration Checklist

- [ ] CLI commands work correctly
- [ ] `manifest.json` generated and reviewed
- [ ] Output paths are accurate
- [ ] Secrets embedded in wheel (if needed)
- [ ] Wheel copied to appropriate directory
- [ ] `docker compose build` completes successfully
- [ ] Capability appears in `capabilities/manifest.json`

## Debugging

### Manifest Not Generated

```bash
# Run installer manually to see errors
cd /path/to/aech-main
python capabilities/installer.py
```

### CLI Not Found in Container

```bash
# Check if wheel is copied
docker compose run agent ls -la /app/capabilities/clis/

# Check if CLI is installed
docker compose run agent which aech-cli-yourname
```

## Resources

- [cli_template/README.md](../development/cli_template/README.md) - Template usage guide
- [capabilities/installer.py](../capabilities/installer.py) - Manifest aggregator
- Existing CLIs for reference:
  - aech-cli-pbwc - Sales data CLI
  - aech-cli-msgraph - Microsoft 365 integration
