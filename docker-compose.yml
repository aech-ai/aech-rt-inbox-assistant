services:
  inbox-assistant:
    build:
      context: ..
      dockerfile: aech-rt-inbox-assistant/Dockerfile
    image: aech-rt-inbox-assistant
    gpus: all
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
              count: 1 # or 'all' to use all available GPUs
    env_file:
      - .env
    volumes:
      # AECH_HOST_DATA: path to aech-main/data on host (set in .env)
      - ${AECH_HOST_DATA}/users/${DELEGATED_USER}:/home/agentaech
      # RT trigger queue root (outbox/processing/done/failed/dedupe)
      - ${AECH_HOST_DATA}/rt_triggers/inbox-assistant:/triggers:rw
      # Token cache (explicit for clarity)
      - ${AECH_HOST_DATA}/app_context/aech-cli-msgraph/token_cache.json:/app/token_cache.json
    restart: unless-stopped
    environment:
      - PYTHONUNBUFFERED=1
      - OPENAI_API_KEY
      - MSGRAPH_TOKEN
      - DELEGATED_USER
      - POLL_INTERVAL
      - MODEL_NAME
      - AZURE_CLIENT_ID
      - AZURE_TENANT_ID
      - MSGRAPH_TOKEN_CACHE_PATH=/app/token_cache.json
      # User's timezone for calendar queries (e.g., America/Los_Angeles, America/New_York)
      - DEFAULT_TIMEZONE=${DEFAULT_TIMEZONE:-America/Los_Angeles}
      # Optional: set specific environment variables for Spark/CUDA if needed
      - NVIDIA_VISIBLE_DEVICES=all
